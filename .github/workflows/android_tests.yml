name: Android Tests - SDK QA Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'SDK Version to test'
        required: false
        default: '9.6.0'

jobs:
  test:
    runs-on: macos-latest
    
    strategy:
      fail-fast: false
      matrix:
        sdk_version:
          - "9.6.0"
          - "9.7.0"
          - "9.8.0"
          - "9.9.1-alpha04"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Create AVD and generate snapshot for caching
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: echo "Generated AVD snapshot"
      
      - name: Update SDK version in build.gradle.kts
        run: |
          SDK_VERSION="${{ matrix.sdk_version }}"
          sed -i '' "s/mediastreamplatformsdkandroid:.*/mediastreamplatformsdkandroid:$SDK_VERSION\"/" app/build.gradle.kts
          echo "Updated SDK version to $SDK_VERSION"
          cat app/build.gradle.kts | grep mediastreamplatformsdkandroid
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Run tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            ./gradlew connectedAndroidTest --stacktrace --no-daemon
      
      - name: Install Allure CLI
        if: always()
        run: |
          curl -o allure-2.24.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          tar -zxvf allure-2.24.0.tgz
          sudo mv allure-2.24.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version
      
      - name: Collect Allure results
        if: always()
        run: |
          mkdir -p allure-results
          # Copiar resultados XML de JUnit y convertirlos a formato Allure
          if [ -d "app/build/outputs/androidTest-results/connected" ]; then
            find app/build/outputs/androidTest-results/connected -name "*.xml" -exec cp {} allure-results/ \;
          fi
      
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean || echo "No se pudieron generar reportes de Allure"
      
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-sdk-${{ matrix.sdk_version }}
          path: allure-results
          retention-days: 30
      
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-sdk-${{ matrix.sdk_version }}
          path: allure-report
          retention-days: 30
      
      - name: Extract test results
        if: always()
        id: test-results
        run: |
          # Intentar extraer de archivos XML de JUnit
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          
          if [ -d "app/build/outputs/androidTest-results/connected" ]; then
            for xml_file in app/build/outputs/androidTest-results/connected/*.xml; do
              if [ -f "$xml_file" ]; then
                TESTS=$(grep -o 'tests="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                FAILURES=$(grep -o 'failures="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                ERRORS=$(grep -o 'errors="[0-9]*"' "$xml_file" | head -1 | grep -o '[0-9]*' || echo "0")
                
                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                FAILED_TESTS=$((FAILED_TESTS + FAILURES + ERRORS))
              fi
            done
          fi
          
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "sdk_version=${{ matrix.sdk_version }}" >> $GITHUB_OUTPUT
          
          echo "Test Results for SDK ${{ matrix.sdk_version }}:"
          echo "  Total: $TOTAL_TESTS"
          echo "  Passed: $PASSED_TESTS"
          echo "  Failed: $FAILED_TESTS"
      
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "ðŸ§ª Android Tests - SDK QA Suite",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ§ª Android Tests - SDK QA Suite"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*SDK Version:*\n${{ matrix.sdk_version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.test-results.outputs.failed == '0' && 'ðŸŸ¢ PASSED' || 'ðŸ”´ FAILED' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Total Tests:*\n${{ steps.test-results.outputs.total }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Passed:*\n${{ steps.test-results.outputs.passed }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Failed:*\n${{ steps.test-results.outputs.failed }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Allure Report:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Download Artifact>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Commit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}> | Branch: ${{ github.ref_name }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  
  deploy-report:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all Allure reports
        uses: actions/download-artifact@v4
        with:
          pattern: allure-report-*
          merge-multiple: true
          path: allure-reports
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-reports
          destination_dir: ./test-reports
